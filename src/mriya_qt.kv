#:kivy 1.7.1
#:import ListAdapter kivy.adapters.listadapter.ListAdapter
#:import Factory kivy.factory.Factory
#:import Button kivy.uix.button.Button
#:import classes kv_classes

<Screen>:
    canvas:
        Color:
            rgb: .2, .2, .2
        Rectangle:
            size: self.size

<MutableLabelTextInput@MutableTextInput>:
    Label:
        id: w_label
        pos: root.pos
        text: root.text

    TextInput:
        id: w_textinput
        pos: root.pos
        text: root.text
        multiline: root.multiline
        on_focus: root.check_focus_and_view(self)

<MutableRstDocumentTextInput@MutableTextInput>:
    RstDocument:
        id: w_label
        pos: root.pos
        text: root.text

    TextInput:
        id: w_textinput
        pos: root.pos
        text: root.text
        multiline: root.multiline
        on_focus: root.check_focus_and_view(self)


<FiledListButton@ListItemButton>:
#    selected_color: 0, 0, 1, 1
#    deselected_color: 0, 0, 0, 1
    halign: 'left'
    text_size: self.size


<StartScreen>:
    BoxLayout:
        orientation: 'vertical'
        BoxLayout:
            size_hint_y: None
            height: 35
            orientation: 'horizontal'
            TextInput:
                id: text_input
                height: 35
                multiline: False
                text:app.default_project_dir
            Button:
                text: '>>'
                size_hint_x: None
                size_hint_y: None
                width:self.height
                size_hint_y: None
                height: 35
                on_release: app.go_to_project(text_input.text)
        Button:
            text: 'Load Project'
            size_hint_y: None
            height: 45
            on_release: root.show_load()
        Button:
            text: 'New Project'
            size_hint_y: None
            height: 45
            on_release: root.show_save()
#        Widget:
        BoxLayout:
            orientation: 'vertical'
            StackLayout:
                id:st_layout


<ReviewScreen>:
    BoxLayout:
        orientation: 'vertical'
        BoxLayout:
            size_hint_y: None
            height: 35
            orientation: 'horizontal'
            Button:
                text: '<<'
                size_hint_x: None
                size_hint_y: None
                width:self.height
                size_hint_y: None
                height: 35
                on_release: app.go_back_to_task(root.previous_screen)
            TextInput:
                id: text_input_file_name
                height: 35
                multiline: False
                text:root.file_name
            TextInput:
                id: ti_lines
                size_hint_x: None
                size_hint_y: None
                height: 35
                width: 50
                multiline: False
                text:'200'
                on_text:root.load_data()
        BoxLayout:
            TextInput:
                id: ti_text
                multiline: True

<LoadDialog>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            path:app.default_application_dir

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()

            Button:
                text: "Load"
                on_release: root.load(filechooser.path, filechooser.selection)

<SaveDialog>:
    text_input: text_input
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            path:app.default_application_dir
            on_selection: text_input.text = self.selection and self.selection[0] or ''

        TextInput:
            id: text_input
            size_hint_y: None
            height: 30
            multiline: False

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()

            Button:
                text: "Save"
                on_release: root.save(filechooser.path, text_input.text)

<TaskView>:
    object_fileds: lv_fields
    #selected_filed: lv_selected_fields
    BoxLayout:
        orientation: 'vertical'
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: '48dp'
            padding: '5dp'
            canvas:
                Color:
                    rgb: .3, .3, .3
                Rectangle:
                    pos: self.pos
                    size: self.size
            Button:
                text: '<'
                size_hint_x: None
                width: self.height
                on_release: app.go_tasks({'tttt':''})
            TextInput:
                id:ti_task_name
                text: root.task_title
                on_text: root.on_task_title_changed(app.get_task_names())
            Label:
                size_hint_x: None
                width: self.height * 3
                text:'Run in workflow'
            CheckBox:
                id:cb_run_in_workflow
                active:root.task_exec
                size_hint_x: None
                width: self.height
            Button:
                text: 'Exec'
                size_hint_x: None
                width: self.height
                on_release: root.exec_item(root.task_index)
            Button:
                text: 'Save'
                size_hint_x: None
                width: self.height
                on_release: app.save_task(root.task_index, {'sql':ti_sql.text, 'source':ce_source.text, 'type':'SF_Query', 'output':ti_output.text, 'input':'', 'title':ti_task_name.text, 'exec' :cb_run_in_workflow.active})
            Button:
                text: 'X'
                size_hint_x: None
                width: self.height
                on_release: app.del_task(root.task_index)
        BoxLayout:
            orientation: 'horizontal'
            BoxLayout:
                size_hint_x: 0.3
                orientation: 'vertical'
                Label:
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None
                    text: 'Source:'
                ComboEdit:
                    id:ce_source
                    size_hint_y: None
                    height: '30dp'
                    options: [Button(text = str(x), size_hint_y=None, height=30) for x in root.sources_list]
                    text: 'Select source' if root.task_source == '' else root.task_source
                    on_text: root.read_controls(app.get_task_names())
                Label:
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None
                    text: 'Object:'
                ComboEdit:
                    id:ce_object
                    size_hint_y: None
                    height: '30dp'
                    options: [Button(text = str(x), size_hint_y=None, height=30) for x in root.objects_list]
                    text: 'Select object' if app.project.get_object_from_sql(root.task_sql) is None and app.project.get_object_from_sql(root.task_sql) not in app.project.get_sobjects(self.ce_source) else app.project.get_object_from_sql(root.task_sql)
                    on_text:root.read_controls(app.get_task_names())
                Label:
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None
                    text: 'Fields:'
                TextInput:
                    id:ti_filter_fields
                    size_hint_y: None
                    height: '30dp'
                    text: ''
                    on_text: root.on_text_field_filter(self.text)
                ListView:
                    id:lv_fields
                    halign: 'left'
                    text_size: self.size
                    adapter: ListAdapter( data=root.object_fileds.adapter.data, cls=classes.FiledListButton, on_selection_change=root.on_select_object_fileds_list)
                Label:
                    text: 'Output file:'
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None

            BoxLayout:
                orientation: 'vertical'
                StackLayout:
                    id:st_layout
                    size_hint_y: 0.4
                TextInput:
                    id:ti_sql
                    multiline: True
                    text: 'INPUT SQL' if root.task_sql == '' else root.task_sql
                    on_text:root.on_sql_texinput_change()
                BoxLayout:
                    orientation: 'horizontal'
                    size_hint_y: None
                    height:'35dp'
                    TextInput:
                        id: ti_output
                        size_hint_y: None
                        height: '30dp'
                        text: root.task_output
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height:'35dp'
            Label:
                text: 'Status:'
                size_hint_y: None
                height:'35dp'

<SQLView>:

    task_list: lv_tasks
    field_list: lv_fields

    BoxLayout:
        orientation: 'vertical'
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: '48dp'
            padding: '5dp'
            canvas:
                Color:
                    rgb: .3, .3, .3
                Rectangle:
                    pos: self.pos
                    size: self.size
            Button:
                text: '<'
                size_hint_x: None
                width: self.height
                on_release: app.go_tasks({'tttt':''})
            TextInput:
                id:ti_task_name
                text: root.task_title
                on_text: root.on_task_name_change(app.get_task_names())
            Label:
                size_hint_x: None
                width: self.height * 3
                text:'Run in workflow'
            CheckBox:
                id:cb_run_in_workflow
                active:root.task_exec
                size_hint_x: None
                width: self.height
            Button:
                text: 'Exec'
                size_hint_x: None
                width: self.height
#                on_release: root.on_task_list_click()
            Button:
                text: 'Save'
                size_hint_x: None
                width: self.height
                on_release: app.save_task(root.task_index, {'sql':ti_sql.text, 'source':'', 'type':'SQL_Query', 'output':ti_output.text, 'input':ti_input_objects.text, 'title':ti_task_name.text, 'exec' : cb_run_in_workflow.active})
            Button:
                text: 'X'
                size_hint_x: None
                width: self.height
        BoxLayout:
            orientation: 'horizontal'
            BoxLayout:
                size_hint_x: 0.3
                orientation: 'vertical'
                Label:
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None
                    text: 'Available objects:'
                TextInput:
                    id:ti_filter_objects
                    size_hint_y: None
                    height: '30dp'
                    text: ''
                    on_text: root.on_text_object_filter(self.text)
                ListView:
                    id:lv_tasks
                    halign: 'left'
                    text_size: self.size
                    adapter: ListAdapter( data=root.task_list.adapter.data, cls=classes.FiledListButton, on_selection_change=root.on_task_list_click)
                TextInput:
                    id:ti_filter_fields
                    size_hint_y: None
                    height: '30dp'
                    text: ''
                    on_text: root.on_text_field_filter(self.text)
                ListView:
                    id:lv_fields
                    halign: 'left'
                    text_size: self.size
                    adapter: ListAdapter( data=root.field_list.adapter.data, cls=classes.FiledListButton, on_selection_change=root.on_field_list_click_item)
                Label:
                    text: 'Output file:'
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None

            BoxLayout:
                orientation: 'vertical'
                Label:
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None
                    text: 'Input objects:'
                TextInput:
                    id:ti_input_objects
                    size_hint_y: 0.2
                    height: '30dp'
                    text: root.task_input
                    on_text:root.on_text_input_objects()
                StackLayout:
                    id:st_layout
                    size_hint_y: 0.4
                TextInput:
                    id:ti_sql
                    multiline: True
                    text: root.task_sql
                BoxLayout:
                    orientation: 'horizontal'
                    size_hint_y: None
                    height:'35dp'
                    TextInput:
                        id: ti_output
                        size_hint_y: None
                        height: '30dp'
                        text: root.task_output
                    Button:
                        text: 'View'
                        size_hint_y: None
                        size_hint_x: None
                        height: '30dp'
                        width: self.height + 10
                        on_release: app.go_to_review_screen(root.task_output)

<BatchExecuteView>:
    #field_list: lv_source_fields
    BoxLayout:
        orientation: 'vertical'
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: '48dp'
            padding: '5dp'
            canvas:
                Color:
                    rgb: .3, .3, .3
                Rectangle:
                    pos: self.pos
                    size: self.size
            Button:
                text: '<'
                size_hint_x: None
                width: self.height
                on_release: app.go_tasks({'tttt':''})
            TextInput:
                id:ti_task_name
                text: root.task_title
                on_text: root.on_task_name_change(app.get_task_names())
            Label:
                size_hint_x: None
                width: self.height * 3
                text:'Run in workflow'
            CheckBox:
                id:cb_run_in_workflow
                active:root.task_exec
                size_hint_x: None
                width: self.height
            Button:
                text: 'Save'
                size_hint_x: None
                width: self.height
                on_release: app.save_task(root.task_index, {'sql':ce_object.text, 'source':ce_source.text, 'type':'SF_Execute', 'output':ti_output.text, 'input':ti_text_input_source_file_name.text, 'title':ti_task_name.text, 'exec' : cb_run_in_workflow.active, 'command':ce_exec_type.text, 'external_id_name':ce_external_id_name.text, 'concurrency':ce_concurrency.text, 'batch_size':ti_batch_size.text})
            Button:
                text: 'X'
                size_hint_x: None
                width: self.height
        BoxLayout:
            orientation: 'horizontal'
            BoxLayout:
                size_hint_x: 0.3
                orientation: 'vertical'
                Label:
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None
                    text: 'Source:'
                ComboEdit:
                    id:ce_source
                    size_hint_y: None
                    height: '30dp'
                    options: [Button(text = str(x), size_hint_y=None, height=30) for x in root.sources_list]
                    text: 'Select source' if root.task_source == '' else root.task_source
                    on_text: root.read_controls(app.get_task_names())
                Label:
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None
                    text: 'Object:'
                ComboEdit:
                    id:ce_object
                    size_hint_y: None
                    height: '30dp'
                    options: [Button(text = str(x), size_hint_y=None, height=30) for x in root.objects_list]
                    text: 'Select object' if root.task_sql is None  else root.task_sql
#                    on_text:root.read_controls(app.get_task_names())
                Label:
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None
                    text: 'Exec type:'
                ComboEdit:
                    id:ce_exec_type
                    size_hint_y: None
                    height: '30dp'
                    options: [Button(text = str(x), size_hint_y=None, height=30) for x in ['insert', 'update', 'delete']]
                    text: 'Select operation type' if root.task_command is None  else root.task_command
                    on_text:root.on_exec_type_text()

                Label:
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None
                    text: 'Source file:'
                ComboEdit:
                    id:ce_source_file
                    size_hint_y: None
                    height: '30dp'
                    options: [Button(text = str(x), size_hint_y=None, height=30) for x in root.task_list]
                    text: 'Select source file' if root.task_input is None else root.get_task_name_from_file(root.task_input)
                    on_text:root.on_exec_type_text()
                Label:
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None
                    text: 'External field:'
                ComboEdit:
                    id:ce_external_id_name
                    size_hint_y: None
                    height: '30dp'
                    options: [Button(text = str(x), size_hint_y=None, height=30) for x in sorted(root.get_csv_fields(root.task_input))]
                    text: 'Select external field' if root.task_external_id_name is None else root.task_external_id_name
                Label:
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None
                    text: 'Batch size:'
                TextInput:
                    id:ti_batch_size
                    size_hint_y: None
                    height: '30dp'
                    text: '5000' if root.task_batch_size == '' else root.task_batch_size
                    disabled:False
                Label:
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None
                    text: 'Concurrency Mode:'
                ComboEdit:
                    id:ce_concurrency
                    options: [Button(text = str(x), size_hint_y=None, height=30) for x in ['Parallel', 'Serial']]
                    size_hint_y: None
                    height: '30dp'
                    text: 'Parallel' if root.task_concurrency == '' else root.task_concurrency
                    disabled:False

                Label:
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None
                    text: 'API:'
                ComboEdit:
                    id:ce_api
                    options: [Button(text = str(x), size_hint_y=None, height=30) for x in ['BulkAPI', 'SoAPI']]
                    size_hint_y: None
                    height: '30dp'
                    text: 'BulkAPI'
                    disabled:True
                ListView:
                    id:dummy
                    halign: 'left'
                Label:
                    text: 'Output file:'
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None

            BoxLayout:
                orientation: 'vertical'
                Label:
                    size_hint_y: None
                    height:'35dp'
                    text_size: self.width, None
                    text: 'Preview file:'
                BoxLayout:
                    orientation: 'horizontal'
                    #size_hint_x: None
                    size_hint_y: None
                    height:'35dp'
                    TextInput:
                        id: ti_text_input_source_file_name
                        height: 35
                        size_hint_y: None
                        multiline: False
#                        text:root.preview_source_file_name
                        text:root.task_input
                        on_text:root.load_data(self.text)
                    TextInput:
                        id: ti_lines
                        size_hint_x: None
                        size_hint_y: None
                        height: 35
                        width: 50
                        multiline: False
                        text:'200'
                StackLayout:
                    id:st_layout
                    #size_hint_x: None
                    size_hint_y: 0.4
                TextInput:
                    id:ti_source_preview
                    multiline: True
                    text: root.preview_text
                BoxLayout:
                    orientation: 'horizontal'
                    size_hint_y: None
                    height:'35dp'
                    TextInput:
                        id: ti_output
                        size_hint_y: None
                        height: '30dp'
                        text: root.task_output
                    Button:
                        text: 'ViewErrors'
                        size_hint_y: None
                        size_hint_x: None
                        height: '30dp'
                        width: self.height + 60
                        on_release: app.go_to_review_screen(root.task_output, True)
                    Button:
                        text: 'View'
                        size_hint_y: None
                        size_hint_x: None
                        height: '30dp'
                        width: self.height + 10
                        on_release: app.go_to_review_screen(root.task_output, False)


<TaskListItem>:
    height: '45sp'
    size_hint_y: None

    canvas:
        Color:
            rgb: 0.3, 0.3, 0.3
        Rectangle:
            pos: self.pos
            size: self.width, 1

    BoxLayout:
        padding: '5dp'
        Button:
            id:del_bbutton
            text: 'Del'
            size_hint_x: None
            width: self.height * 1.5
            background_color: (0.5,0,0,1) if self.state == 'normal' else (0,1,0,1)
            background_normal: ""
            on_release: app.call_del_task(root.task_index)
#        Label:
#            id:label_task_spacer

#        Label:
#            id:label_task_info
#            pos:(del_bbutton.pos[0] + del_bbutton.width, del_bbutton.pos[1])
#            text_size_x:self.width
#            halign: 'right'
#            color:(0.4,0.4,0.6,1) if root.task_type=='SQL_Query' else (0.5,0.5,0.5,1) if root.task_type=='SF_Query' else (0.5,0.5,0.6,1)
#            size_hint_x: 0.2
#            canvas.before:
#                Color:
#                    rgb: (0.3,0.3,0.5,1) if root.task_type=='SQL_Query' else (0.4,0.4,0.4,1) if root.task_type=='SF_Query' else (0.4,0.4,0.5,1)
#                Rectangle:
#                    pos: self.pos
#                    size: self.width, self.height
#            text: app.get_record_count(root.task_index)

        Label:
            id:label_task_name
            canvas.before:
                Color:
                    rgb: root.get_color()
                Rectangle:
                    pos: (self.pos[0]+1,self.pos[1])
                    size: self.width, self.height
            text: root.task_title
        Switch:
            size_hint_x: None
            id:sw_exec
            width: self.height * 3
            on_active: app.on_skip_task(self, self.active, root.task_index)
            active:root.task_exec
#        Button:
#            text: 'Execute'
#            size_hint_x: None
#            background_color: (0,0.5,0,1) if self.state == 'normal' else (0,1,0,1)
#            background_normal: ""
#            width: self.height * 2
#            on_release: app.exec_task(root.task_index)
        Button:
            text: 'Up'
            size_hint_x: None
            width: self.height * 1.5
            on_release: app.up_task(root.task_index)
        Button:
            text: 'Down'
            size_hint_x: None
            width: self.height * 1.5
            on_release: app.down_task(root.task_index)
        Button:
            text: '>'
            size_hint_x: None
            width: self.height
            on_release: app.edit_task(root.task_index)

<Tasks>:
    BoxLayout:
        orientation: 'vertical'
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: '48dp'
            padding: '5dp'
            canvas:
                Color:
                    rgb: .3, .3, .3
                Rectangle:
                    pos: self.pos
                    size: self.size

#            Button:
#                text: 'Settings'
#                size_hint_x: None
#                width: self.height*2
#                on_release: app.goto_settings()

#            Button:
#                text: 'Macros'
#                size_hint_x: None
#                width: self.height*2
#                on_release: app.goto_settings()

            Label:
                text: app.project.project_name
                font_size: '16sp'

            Button:
                text: 'Exec All'
                size_hint_x: None
                width: self.height * 2
                on_release: app.cal_exec_workflow()
            Button:
#                canvas:
#                    Rectangle:
#                        source:'icons/sf.png'
#                       size: self.size
#                        size: self.size[0]-10,self.size[1]-10
#                        pos: self.pos[0]+5,self.pos[1]+5
                text: 'SF Query'
                size_hint_x: None
                width: self.height * 2
                on_release: app.add_task('SF_Query')
            Button:
                text: 'CSV query'
                size_hint_x: None
                width: self.height * 2
                on_release: app.add_task('SQL_Query')
            Button:
                text: 'SF Execute'
                size_hint_x: None
                width: self.height * 2
                on_release: app.add_task('SF_Execute')

        ListView:
            id:lv_tasks
            adapter: ListAdapter(data=root.data, cls=Factory.TaskListItem, args_converter=root.args_converter)
        TextInput:
            use_bubble:True
            id: ti_log
            size_hint_y: None
            multiline: True
            height: '100dp'
            background_color: (0.8, 0.8, 0.8, 1)
            text: ''

